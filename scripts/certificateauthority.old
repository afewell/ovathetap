#!/bin/bash
## script vars
hostusername="${hostusername:-viadmin}"
echo "${hostusername}"
home_dir="${home_dir:-~}"
echo "${home_dir}"
ovathetap_assets="${ovathetap_assets}"
echo "${ovathetap_assets}"

## Create Private Key for CA
mkdir -p "/${home_dir}/.pki/myca"
openssl genrsa -out "/${home_dir}/.pki/myca/myca.key" 4096
## Create Private Key for Harbor server certificate
openssl genrsa -out "/${home_dir}/.pki/myca/harbor.tanzu.demo.key" 4096
## Create CA Cert
openssl req -x509 -new -nodes -sha512 -days 3650 \
 -subj "/C=CN/ST=Washington/L=Seattle/O=VMware/OU=mamburger/CN=tanzu.demo" \
 -key "/${home_dir}/.pki/myca/myca.key" \
 -out "/${home_dir}/.pki/myca/myca.crt"
## Make a copy of the ca cert as a pem file
openssl x509 -outform pem -in "/${home_dir}/.pki/myca/myca.crt" -out "/${home_dir}/.pki/myca/myca.pem"
## Create Certificate Signing Request for Harbor server
openssl req -sha512 -new \
    -subj "/C=CN/ST=Washington/L=Seattle/O=VMware/OU=mamburger/CN=harbor.tanzu.demo" \
    -key "/${home_dir}/.pki/myca/harbor.tanzu.demo.key" \
    -out "/${home_dir}/.pki/myca/harbor.tanzu.demo.csr"
## Generate an x509 v3 extension file for Harbor server
cat > "/${home_dir}/.pki/myca/v3.ext" <<-EOF
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[alt_names]
DNS.1=harbor.tanzu.demo
DNS.2=tanzu.demo
DNS.3=harbor
EOF
## Create Harbor server certificate
openssl x509 -req -sha512 -days 3650 \
    -extfile "/${home_dir}/.pki/myca/v3.ext" \
    -CA "/${home_dir}/.pki/myca/myca.crt" -CAkey "/${home_dir}/.pki/myca/myca.key" -CAcreateserial \
    -in "/${home_dir}/.pki/myca/harbor.tanzu.demo.csr" \
    -out "/${home_dir}/.pki/myca/harbor.tanzu.demo.crt"
## Make a copy of the harbor server cert as a pem file
openssl x509 -outform pem -in "/${home_dir}/.pki/myca/harbor.tanzu.demo.crt" -out "/${home_dir}/.pki/myca/harbor.tanzu.demo.pem"
## Convert harbor.tanzu.demo.crt to harbor.tanzu.demo.cert, for use by Docker
openssl x509 -inform PEM -in "/${home_dir}/.pki/myca/harbor.tanzu.demo.crt" -out "/${home_dir}/.pki/myca/harbor.tanzu.demo.cert"
## Copy the generated files into the docker certs directory
mkdir -p "/etc/docker/certs.d/tanzu.demo"
mkdir -p "/etc/docker/certs.d/harbor.tanzu.demo"
cp "/${home_dir}/.pki/myca/myca.crt" "/etc/docker/certs.d/tanzu.demo/ca.crt"
cp "/${home_dir}/.pki/myca/myca.crt" "/etc/docker/certs.d/harbor.tanzu.demo/ca.crt"
cp "/${home_dir}/.pki/myca/harbor.tanzu.demo.cert" "/etc/docker/certs.d/harbor.tanzu.demo/harbor.tanzu.demo.cert"
cp "/${home_dir}/.pki/myca/harbor.tanzu.demo.cert" "/etc/docker/certs.d/harbor.tanzu.demo/harbor.tanzu.demo.cert"
## Also copy the certs into a directory that includes the port number per harbor docs
mkdir -p "/etc/docker/certs.d/harbor.tanzu.demo:${minikube_harbor_port}"
cp "/${home_dir}/.pki/myca/myca.crt" "/etc/docker/certs.d/harbor.tanzu.demo:${minikube_harbor_port}/ca.crt"
cp "/${home_dir}/.pki/myca/harbor.tanzu.demo.cert" "/etc/docker/certs.d/harbor.tanzu.demo:${minikube_harbor_port}/harbor.tanzu.demo.cert"
cp "/${home_dir}/.pki/myca/harbor.tanzu.demo.cert" "/etc/docker/certs.d/harbor.tanzu.demo:${minikube_harbor_port}/harbor.tanzu.demo.cert"
## Set {hostusername} as owner of cert files
chown -R "${hostusername}:docker" "/etc/docker/certs.d/tanzu.demo/"
chown -R "${hostusername}:docker" "/etc/docker/certs.d/harbor.tanzu.demo/"
chown -R "${hostusername}:${hostusername}" "/${home_dir}/.pki/"
## Copy certs to minikube
mkdir -p "/${home_dir}/.minikube/certs/"
cp "/${home_dir}/.pki/myca/myca.pem" "/${home_dir}/.minikube/certs/myca.pem"
cp "/${home_dir}/.pki/myca/myca.crt" "/${home_dir}/.minikube/certs/myca.crt"
cp "/${home_dir}/.pki/myca/harbor.tanzu.demo.cert" "/${home_dir}/.minikube/certs/harbor.tanzu.demo.cert"
chown -R "${hostusername}:docker" "/${home_dir}/.minikube/"
## Install root CA cert in ubuntu trust store so localhost trusts CA
apt install -y ca-certificates
cp "/${home_dir}/.pki/myca/harbor.tanzu.demo.crt" /etc/ssl/certs
cp "/${home_dir}/.pki/myca/harbor.tanzu.demo.key" /etc/ssl/private
cp "/${home_dir}/.pki/myca/myca.pem" /usr/local/share/ca-certificates
ln -s "/${home_dir}/.pki/myca/myca.pem" /etc/ssl/certs/cacert.pem
update-ca-certificates